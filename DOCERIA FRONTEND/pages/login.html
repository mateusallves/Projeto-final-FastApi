<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Doce Encanto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="pages.css">
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="container header-content">
            <a href="../index.html" class="logo">Doce <span>Encanto</span></a>
            <nav class="nav-menu" id="navMenu">
                <a href="../index.html">INÍCIO</a>
                <a href="doceria.html">DOCERIA</a>
                <a href="kit-festa.html">KIT FESTA</a>
                <a href="sobre.html">SOBRE</a>
                <a href="contato.html">CONTATO</a>
            </nav>
            <div class="header-actions">
                <a href="carrinho.html" class="cart-btn">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </a>
                <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <!-- AUTH SECTION -->
    <section class="auth-section">
        <div class="auth-container">
            <!-- LOGIN FORM -->
            <div class="auth-box" id="loginBox">
                <div class="auth-header">
                    <i class="fas fa-user-circle"></i>
                    <h2>Bem-vindo de volta!</h2>
                    <p>Entre para continuar suas compras</p>
                </div>

                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">E-mail</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="loginEmail" required placeholder="seu@email.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="loginPassword">Senha</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="loginPassword" required placeholder="Sua senha">
                            <button type="button" class="toggle-password" onclick="togglePassword('loginPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-options">
                        <label class="checkbox">
                            <input type="checkbox" id="rememberMe">
                            <span>Lembrar-me</span>
                        </label>
                        <a href="#" class="forgot-link">Esqueceu a senha?</a>
                    </div>

                    <button type="submit" class="btn-auth">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                    <div id="loginFeedback" class="form-feedback" hidden></div>

                    <div class="auth-divider">
                        <span>ou</span>
                    </div>

                    <p class="auth-switch">
                        Não tem uma conta? 
                        <a href="#" onclick="showRegister()">Cadastre-se</a>
                    </p>
                </form>
            </div>

            <!-- REGISTER FORM -->
            <div class="auth-box" id="registerBox" style="display: none;">
                <div class="auth-header">
                    <i class="fas fa-user-plus"></i>
                    <h2>Crie sua conta</h2>
                    <p>Cadastre-se para fazer seus pedidos</p>
                </div>

                <form id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label for="registerName">Nome completo</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="registerName" required placeholder="Seu nome">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="registerEmail">E-mail</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="registerEmail" required placeholder="seu@email.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="registerPhone">Telefone</label>
                        <div class="input-icon">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="registerPhone" required placeholder="(11) 99999-9999">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="registerPassword">Senha</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="registerPassword" required placeholder="Crie uma senha" minlength="6">
                            <button type="button" class="toggle-password" onclick="togglePassword('registerPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="registerConfirm">Confirmar senha</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="registerConfirm" required placeholder="Confirme sua senha">
                        </div>
                    </div>

                    <label class="checkbox terms">
                        <input type="checkbox" id="acceptTerms" required>
                        <span>Aceito os <a href="#">termos de uso</a> e <a href="#">política de privacidade</a></span>
                    </label>

                    <button type="submit" class="btn-auth">
                        <i class="fas fa-user-plus"></i> Criar Conta
                    </button>

                    <div class="auth-divider">
                        <span>ou</span>
                    </div>

                    <p class="auth-switch">
                        Já tem uma conta? 
                        <a href="#" onclick="showLogin()">Entrar</a>
                    </p>
                </form>
            </div>
        </div>
    </section>

    <!-- FOOTER MINIMAL -->
    <footer class="footer-minimal">
        <div class="container">
            <p>&copy; 2024 Delicious Doceria - Todos os direitos reservados</p>
        </div>
    </footer>

    <script src="../js/api.js"></script>
    <script src="../js/cart.js"></script>
    <script src="../js/main.js"></script>
    <script>
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const rememberMeCheckbox = document.getElementById('rememberMe');
        const loginFeedback = document.getElementById('loginFeedback');
        const loginSubmitButton = document.querySelector('#loginForm .btn-auth');
        const LOGIN_REMEMBER_KEY = 'rememberedEmail';

        prefillLoginEmail();

        function showLogin() {
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('registerBox').style.display = 'none';
            resetLoginFeedback();
        }

        function showRegister() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('registerBox').style.display = 'block';
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function prefillLoginEmail() {
            const savedEmail = localStorage.getItem(LOGIN_REMEMBER_KEY);
            if (savedEmail && loginEmailInput) {
                loginEmailInput.value = savedEmail;
                rememberMeCheckbox.checked = true;
            }
        }

        function showLoginFeedback(message, type = 'error') {
            if (!loginFeedback) return;
            loginFeedback.textContent = message;
            loginFeedback.classList.remove('error', 'success');
            loginFeedback.classList.add(type);
            loginFeedback.hidden = false;
        }

        function resetLoginFeedback() {
            if (!loginFeedback) return;
            loginFeedback.hidden = true;
            loginFeedback.textContent = '';
            loginFeedback.classList.remove('error', 'success');
        }

        function setLoginLoading(isLoading) {
            if (!loginSubmitButton) return;
            loginSubmitButton.disabled = isLoading;
            loginSubmitButton.classList.toggle('is-loading', isLoading);
            const icon = loginSubmitButton.querySelector('i');
            if (icon) {
                icon.className = isLoading ? 'fas fa-spinner fa-spin' : 'fas fa-sign-in-alt';
            }
        }

        function getPostLoginRedirect() {
            const params = new URLSearchParams(window.location.search);
            const next = params.get('next');
            return next || '../index.html';
        }

        async function handleLogin(e) {
            e.preventDefault();
            resetLoginFeedback();

            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!email || !password) {
                showLoginFeedback('Informe e-mail e senha.', 'error');
                return;
            }

            setLoginLoading(true);

            try {
                await API.Auth.login(email, password);

                if (rememberMeCheckbox.checked) {
                    localStorage.setItem(LOGIN_REMEMBER_KEY, email);
                } else {
                    localStorage.removeItem(LOGIN_REMEMBER_KEY);
                }

                showLoginFeedback('Login realizado com sucesso! Redirecionando...', 'success');
                const redirectTo = getPostLoginRedirect();
                setTimeout(() => window.location.href = redirectTo, 800);
            } catch (error) {
                showLoginFeedback(error.message || 'Erro no login. Tente novamente.', 'error');
            } finally {
                setLoginLoading(false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;

            if (password !== confirm) {
                alert('As senhas não conferem!');
                return;
            }

            try {
                await API.Auth.register(name, email, password);
                showLogin();
                showLoginFeedback('Conta criada com sucesso! Faça login para continuar.', 'success');
            } catch (error) {
                showLoginFeedback(error.message || 'Erro no cadastro.', 'error');
            }
        }
    </script>
</body>
</html>

