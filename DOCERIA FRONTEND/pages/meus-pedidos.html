<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Pedidos - Doce Encanto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="pages.css">
</head>
<body>
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="container">
            <span><i class="fas fa-clock"></i> Segunda a Sexta: 10h às 18h</span>
            <span><i class="fas fa-phone"></i> (35) 3421-5678 | <i class="fab fa-whatsapp"></i> (35) 99876-5432</span>
        </div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="container header-content">
            <a href="../index.html" class="logo">Doce <span>Encanto</span></a>
            <nav class="nav-menu" id="navMenu">
                <a href="../index.html">INÍCIO</a>
                <a href="doceria.html">DOCERIA</a>
                <a href="kit-festa.html">KIT FESTA</a>
                <a href="sobre.html">SOBRE</a>
                <a href="contato.html">CONTATO</a>
            </nav>
            <div class="header-actions">
                <a href="minha-conta.html" class="account-btn account-btn--logged">
                    <i class="fas fa-user-check"></i>
                    <span id="userName">Minha Conta</span>
                </a>
                <a href="carrinho.html" class="cart-btn">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </a>
                <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <!-- PAGE HEADER -->
    <section class="page-header">
        <div class="container">
            <h1><i class="fas fa-shopping-bag"></i> Meus Pedidos</h1>
            <div class="breadcrumb">
                <a href="../index.html">Início</a>
                <i class="fas fa-chevron-right"></i>
                <a href="minha-conta.html">Minha Conta</a>
                <i class="fas fa-chevron-right"></i>
                <span>Meus Pedidos</span>
            </div>
        </div>
    </section>

    <!-- ORDERS SECTION -->
    <section class="orders-section">
        <div class="container">
            <!-- Filters -->
            <div class="orders-filters">
                <button class="filter-btn active" data-status="">Todos</button>
                <button class="filter-btn" data-status="pendente">Pendentes</button>
                <button class="filter-btn" data-status="confirmado">Confirmados</button>
                <button class="filter-btn" data-status="em_preparo">Em Preparo</button>
                <button class="filter-btn" data-status="pronto">Prontos</button>
                <button class="filter-btn" data-status="saiu_entrega">Saiu para Entrega</button>
                <button class="filter-btn" data-status="entregue">Entregues</button>
                <button class="filter-btn" data-status="cancelado">Cancelados</button>
            </div>

            <!-- Orders List -->
            <div id="ordersList" class="orders-list">
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando pedidos...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyOrders" class="empty-state" style="display: none;">
                <i class="fas fa-shopping-bag"></i>
                <h2>Nenhum pedido encontrado</h2>
                <p>Você ainda não realizou nenhum pedido.</p>
                <a href="doceria.html" class="btn-secondary">Fazer Primeiro Pedido</a>
            </div>
        </div>
    </section>

    <!-- Order Details Modal -->
    <div id="orderModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Pedido</h2>
                <button class="modal-close" onclick="closeOrderModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="orderModalBody" class="modal-body">
                <!-- Order details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col footer-about">
                    <h3 class="logo">Doce <span>Encanto</span></h3>
                    <p>Doces artesanais feitos com amor.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Delicious Doceria</p>
            </div>
        </div>
    </footer>

    <script src="../js/api.js"></script>
    <script src="../js/cart.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/account.js"></script>
    <script>
        let currentStatusFilter = '';

        document.addEventListener('DOMContentLoaded', () => {
            // Verificar autenticação
            if (!API.Auth.isAuthenticated()) {
                window.location.href = 'login.html?next=' + encodeURIComponent(window.location.pathname);
                return;
            }

            // Carregar pedidos
            loadOrders();

            // Event listeners para filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentStatusFilter = btn.dataset.status;
                    loadOrders();
                });
            });
        });

        async function loadOrders() {
            try {
                const user = API.Auth.getUser();
                const cliente = await Account.getOrCreateCliente(user);
                
                let pedidos;
                if (currentStatusFilter) {
                    pedidos = await API.Pedidos.listar(0, 100, currentStatusFilter, cliente.id);
                } else {
                    pedidos = await API.Pedidos.listarPorCliente(cliente.id);
                }

                renderOrders(pedidos);
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                document.getElementById('ordersList').innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Erro ao carregar pedidos. Tente novamente.</p>
                    </div>
                `;
            }
        }

        function renderOrders(pedidos) {
            const ordersList = document.getElementById('ordersList');
            const emptyOrders = document.getElementById('emptyOrders');

            if (pedidos.length === 0) {
                ordersList.style.display = 'none';
                emptyOrders.style.display = 'block';
                return;
            }

            ordersList.style.display = 'block';
            emptyOrders.style.display = 'none';

            ordersList.innerHTML = pedidos.map(pedido => {
                const statusClass = getStatusClass(pedido.status);
                const statusLabel = getStatusLabel(pedido.status);
                const dataPedido = new Date(pedido.data_pedido).toLocaleDateString('pt-BR');

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <h3>Pedido ${pedido.numero_pedido}</h3>
                                <p class="order-date">${dataPedido}</p>
                            </div>
                            <span class="status-badge ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="order-body">
                            <div class="order-info">
                                <p><i class="fas fa-truck"></i> ${pedido.tipo_entrega === 'entrega' ? 'Entrega' : 'Retirada'}</p>
                                <p><i class="fas fa-dollar-sign"></i> R$ ${pedido.total.toFixed(2).replace('.', ',')}</p>
                            </div>
                            <div class="order-actions">
                                <button class="btn-outline" onclick="viewOrderDetails(${pedido.id})">
                                    <i class="fas fa-eye"></i> Ver Detalhes
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            const statusMap = {
                'pendente': 'status-pending',
                'confirmado': 'status-confirmed',
                'em_preparo': 'status-preparing',
                'pronto': 'status-ready',
                'saiu_entrega': 'status-delivering',
                'entregue': 'status-delivered',
                'cancelado': 'status-cancelled'
            };
            return statusMap[status] || 'status-pending';
        }

        function getStatusLabel(status) {
            const labelMap = {
                'pendente': 'Pendente',
                'confirmado': 'Confirmado',
                'em_preparo': 'Em Preparo',
                'pronto': 'Pronto',
                'saiu_entrega': 'Saiu para Entrega',
                'entregue': 'Entregue',
                'cancelado': 'Cancelado'
            };
            return labelMap[status] || status;
        }

        async function viewOrderDetails(pedidoId) {
            try {
                const pedido = await API.Pedidos.buscar(pedidoId);
                const modal = document.getElementById('orderModal');
                const modalBody = document.getElementById('orderModalBody');

                modalBody.innerHTML = `
                    <div class="order-details">
                        <div class="detail-section">
                            <h3>Informações do Pedido</h3>
                            <p><strong>Número:</strong> ${pedido.numero_pedido}</p>
                            <p><strong>Data:</strong> ${new Date(pedido.data_pedido).toLocaleString('pt-BR')}</p>
                            <p><strong>Status:</strong> <span class="status-badge ${getStatusClass(pedido.status)}">${getStatusLabel(pedido.status)}</span></p>
                            <p><strong>Tipo:</strong> ${pedido.tipo_entrega === 'entrega' ? 'Entrega' : 'Retirada'}</p>
                        </div>

                        ${pedido.tipo_entrega === 'entrega' ? `
                        <div class="detail-section">
                            <h3>Endereço de Entrega</h3>
                            <p>${pedido.endereco_entrega}, ${pedido.numero_entrega}</p>
                            ${pedido.complemento_entrega ? `<p>${pedido.complemento_entrega}</p>` : ''}
                            <p>${pedido.bairro_entrega} - ${pedido.cidade_entrega}/${pedido.estado_entrega}</p>
                            <p>CEP: ${pedido.cep_entrega}</p>
                            ${pedido.data_entrega ? `<p><strong>Data/Hora:</strong> ${pedido.data_entrega} ${pedido.hora_entrega || ''}</p>` : ''}
                        </div>
                        ` : ''}

                        <div class="detail-section">
                            <h3>Itens do Pedido</h3>
                            <div class="items-list">
                                ${pedido.itens.map(item => `
                                    <div class="item-row">
                                        <div>
                                            <strong>${item.nome_item}</strong>
                                            <p>${item.descricao_item || ''}</p>
                                        </div>
                                        <div class="item-qty">${item.quantidade}x</div>
                                        <div class="item-price">R$ ${item.subtotal.toFixed(2).replace('.', ',')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Resumo Financeiro</h3>
                            <div class="summary-details">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>R$ ${pedido.subtotal.toFixed(2).replace('.', ',')}</span>
                                </div>
                                ${pedido.desconto > 0 ? `
                                <div class="summary-row">
                                    <span>Desconto:</span>
                                    <span>- R$ ${pedido.desconto.toFixed(2).replace('.', ',')}</span>
                                </div>
                                ` : ''}
                                ${pedido.taxa_entrega > 0 ? `
                                <div class="summary-row">
                                    <span>Taxa de Entrega:</span>
                                    <span>R$ ${pedido.taxa_entrega.toFixed(2).replace('.', ',')}</span>
                                </div>
                                ` : ''}
                                <div class="summary-row total">
                                    <span>Total:</span>
                                    <span>R$ ${pedido.total.toFixed(2).replace('.', ',')}</span>
                                </div>
                            </div>
                            ${pedido.forma_pagamento ? `<p><strong>Forma de Pagamento:</strong> ${pedido.forma_pagamento}</p>` : ''}
                        </div>

                        ${pedido.observacoes ? `
                        <div class="detail-section">
                            <h3>Observações</h3>
                            <p>${pedido.observacoes}</p>
                        </div>
                        ` : ''}
                    </div>
                `;

                modal.style.display = 'flex';
            } catch (error) {
                alert('Erro ao carregar detalhes do pedido: ' + error.message);
            }
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeOrderModal();
            }
        }
    </script>
</body>
</html>

